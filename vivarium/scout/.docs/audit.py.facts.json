{"ast_hash": "0d174ac25f763240bdfb8ec3697b96a359fb5174842800e82a1d156b3fb7c531", "control_flow": {"AuditLog._close_file": [{"blocks": [{"condition": "self._file is not None and (not self._file.closed)", "line": 112, "type": "if"}], "function_name": "AuditLog._close_file"}], "AuditLog._ensure_open": [{"blocks": [{"condition": "self._file is not None and (not self._file.closed)", "line": 80, "type": "if"}], "function_name": "AuditLog._ensure_open"}], "AuditLog._fsync_if_needed": [{"blocks": [{"condition": "self._lines_since_fsync >= FSYNC_EVERY_N_LINES or now - self._last_fsync >= FSYN", "line": 125, "type": "if"}], "function_name": "AuditLog._fsync_if_needed"}], "AuditLog._iter_lines": [{"blocks": [{"condition": "not self._path.exists()", "line": 217, "type": "if"}], "function_name": "AuditLog._iter_lines"}], "AuditLog._maybe_rotate": [{"blocks": [{"condition": "stat.st_size < ROTATION_SIZE_BYTES", "line": 97, "type": "if"}], "function_name": "AuditLog._maybe_rotate"}], "AuditLog.accuracy_metrics": [{"blocks": [{"condition": "total_nav == 0", "line": 298, "type": "if"}], "function_name": "AuditLog.accuracy_metrics"}], "AuditLog.hourly_spend": [{"blocks": [{"condition": "hours <= 0", "line": 262, "type": "if"}], "function_name": "AuditLog.hourly_spend"}], "AuditLog.log": [{"blocks": [{"condition": "cost is not None", "line": 178, "type": "if"}, {"condition": "model is not None", "line": 180, "type": "if"}, {"condition": "input_t is not None", "line": 182, "type": "if"}, {"condition": "output_t is not None", "line": 184, "type": "if"}, {"condition": "files is not None", "line": 186, "type": "if"}, {"condition": "reason is not None", "line": 188, "type": "if"}, {"condition": "confidence is not None", "line": 190, "type": "if"}, {"condition": "duration_ms is not None", "line": 192, "type": "if"}, {"condition": "config is not None", "line": 194, "type": "if"}, {"condition": "raw_brief_path is not None", "line": 196, "type": "if"}], "function_name": "AuditLog.log"}]}, "imports": ["collections.deque", "datetime.datetime", "datetime.timedelta", "datetime.timezone", "gzip", "json", "logging", "os", "pathlib.Path", "threading", "time", "typing.Any", "typing.Dict", "typing.Iterator", "typing.List", "typing.Optional", "uuid"], "path": "/Users/vivariumenv1/Vivarium/vivarium/scout/audit.py", "symbols": {"AuditLog": {"defined_at": 58, "docstring": "Append-only JSONL event log with line buffering, fsync cadence, and crash recovery.\n\n    - Line buffering (buffering=1): flush on newline\n    - Atomic writes: single write() per event, no partial JSON\n    - Fsync: every 10 lines OR every 1 second\n    - Log rotation: auto-archive at 10MB, gzip old logs\n    - Corruption recovery: skip malformed lines on read, log warning", "fields": [], "is_enum": false, "method_signatures": {"__enter__": "def __enter__(self) -> 'AuditLog'", "__exit__": "def __exit__(self, *args: Any) -> None", "__init__": "def __init__(self, path: Path=None)", "_close_file": "def _close_file(self) -> None", "_ensure_open": "def _ensure_open(self) -> None", "_fsync_if_needed": "def _fsync_if_needed(self) -> None", "_iter_lines": "def _iter_lines(self) -> Iterator[str]", "_maybe_rotate": "def _maybe_rotate(self) -> None", "_parse_line": "def _parse_line(self, line: str) -> Optional[Dict[str, Any]]", "accuracy_metrics": "def accuracy_metrics(self, since: datetime) -> Dict[str, Any]", "close": "def close(self) -> None", "flush": "def flush(self) -> None", "gate_metrics": "def gate_metrics(self, since: Optional[datetime]=None, last_n: int=10) -> Dict[str, Any]", "hourly_spend": "def hourly_spend(self, hours: int=1) -> float", "last_events": "def last_events(self, n: int=20, event_type: Optional[str]=None) -> List[Dict[str, Any]]", "log": "def log(self, event_type: str, *, cost: float=None, model: str=None, input_t: int=None, output_t: int=None, files: List[str]=None, reason: str=None, confidence: int=None, duration_ms: int=None, config: Dict[str, Any]=None, raw_brief_path: str=None, **kwargs: Any) -> None", "query": "def query(self, since: Optional[datetime]=None, event_type: Optional[str]=None) -> List[Dict[str, Any]]"}, "methods": ["__init__", "_ensure_open", "_maybe_rotate", "_close_file", "_fsync_if_needed", "log", "_iter_lines", "_parse_line", "query", "hourly_spend", "last_events", "accuracy_metrics", "gate_metrics", "flush", "close", "__enter__", "__exit__"], "name": "AuditLog", "purpose_hint": null, "semantic_role": "implementation", "signature": "def __init__(self, path: Path=None)", "type": "class", "type_annotation": null, "used_at": [], "value": null}, "DEFAULT_AUDIT_PATH": {"defined_at": 29, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "DEFAULT_AUDIT_PATH", "purpose_hint": null, "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [70], "value": "Path('~/.scout/audit.jsonl').expanduser()"}, "EVENT_TYPES": {"defined_at": 35, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "EVENT_TYPES", "purpose_hint": null, "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [], "value": "frozenset({'nav', 'brief', 'cascade', 'validation_fail', 'budget', 'skip', 'trigger', 'tldr', 'tldr_auto_generated', 'deep', 'doc_sync', 'commit_draft', 'pr_snippet', 'impact_analysis', 'module_brief', 'pr_synthesis', 'roast_with_docs'})"}, "FSYNC_EVERY_N_LINES": {"defined_at": 31, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "FSYNC_EVERY_N_LINES", "purpose_hint": null, "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [126], "value": "10"}, "FSYNC_INTERVAL_SEC": {"defined_at": 32, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "FSYNC_INTERVAL_SEC", "purpose_hint": null, "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [127], "value": "1.0"}, "ROTATION_SIZE_BYTES": {"defined_at": 30, "docstring": "10MB", "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "ROTATION_SIZE_BYTES", "purpose_hint": null, "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [97], "value": "10 * 1024 * 1024"}, "_SESSION_ID": {"defined_at": 45, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "_SESSION_ID", "purpose_hint": null, "semantic_role": "implementation", "signature": null, "type": "constant", "type_annotation": "Optional[str]", "used_at": [53, 55], "value": "None"}, "_SESSION_LOCK": {"defined_at": 46, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "_SESSION_LOCK", "purpose_hint": null, "semantic_role": "implementation", "signature": null, "type": "constant", "type_annotation": null, "used_at": [52], "value": "threading.Lock()"}, "_get_session_id": {"defined_at": 49, "docstring": "Return uuid4 session ID, one per process.", "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "_get_session_id", "purpose_hint": null, "semantic_role": "implementation", "signature": "def _get_session_id() -> str", "type": "function", "type_annotation": null, "used_at": [172], "value": null}, "logger": {"defined_at": 26, "docstring": null, "fields": [], "is_enum": false, "method_signatures": {}, "methods": [], "name": "logger", "purpose_hint": "audit logging", "semantic_role": "configuration", "signature": null, "type": "constant", "type_annotation": null, "used_at": [231], "value": "logging.getLogger(__name__)"}}}