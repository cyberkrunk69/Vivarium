#!/bin/bash
# Paste Runner GUI â€” One-click wrapper for paste-runner
# Shows dialog with command count, on Yes opens Terminal and runs paste-runner.
# App is at REPO_ROOT/devtools/paste-runner-gui.app

set -e

export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

SCRIPT_PATH="${BASH_SOURCE[0]}"
[[ -z "$SCRIPT_PATH" ]] && SCRIPT_PATH="$0"
APP_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# .../devtools/paste-runner-gui.app/Contents/MacOS -> devtools is 3 levels up
DEVTOOLS_ROOT="$(cd "$(dirname "$(dirname "$(dirname "$APP_PATH")")")" && pwd)"
REPO_ROOT="$(cd "$(dirname "$DEVTOOLS_ROOT")" && pwd)"

PASTE_RUNNER="$REPO_ROOT/devtools/paste-runner"
PASTE_FILE="${PASTE_FILE:-$REPO_ROOT/paste_block.txt}"

# Count commands (strip comments, empty lines)
if [[ ! -f "$PASTE_FILE" ]]; then
  osascript -e "display dialog \"File not found: $PASTE_FILE\" buttons {\"OK\"} default button 1 with icon stop with title \"Paste Runner\""
  exit 1
fi

N=$(grep -v '^[[:space:]]*#' "$PASTE_FILE" | grep -v '^[[:space:]]*$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -c . 2>/dev/null || echo 0)

if [[ "$N" -eq 0 ]]; then
  osascript -e "display dialog \"No commands found in paste_block.txt (after stripping comments and empty lines).\" buttons {\"OK\"} default button 1 with icon caution with title \"Paste Runner\""
  exit 0
fi

# Show confirmation dialog
reply=$(osascript -e "display dialog \"Found $N command(s) in paste_block.txt.\" & return & return & \"Open Terminal to preview and execute?\" buttons {\"No\", \"Yes\"} default button 2 cancel button 1 with icon 1 with title \"Paste Runner\" -e 'return button returned of result' 2>/dev/null) || reply="No"

if [[ "$reply" == "Yes" ]]; then
  exec_script=$(mktemp)
  {
    printf '#!/bin/bash\n'
    printf 'cd %s && %s\n' "$(printf '%q' "$REPO_ROOT")" "$(printf '%q' "$PASTE_RUNNER")"
    printf 'rm -f "$0"\n'
  } > "$exec_script"
  chmod +x "$exec_script"
  osascript -e "tell application \"Terminal\" to activate" -e "tell application \"Terminal\" to do script \"$(printf '%s' "$exec_script" | sed 's/\\/\\\\/g; s/"/\\"/g')\""
fi
