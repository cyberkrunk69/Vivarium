#!/bin/bash
# Scout Reset GUI — One-click wrapper for scout-reset
# Runs dry-run, shows count and list in dialog, on Reset opens Terminal and runs --confirm.
# App is at REPO_ROOT/devtools/scout-reset-gui.app

set -e

export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

SCRIPT_PATH="${BASH_SOURCE[0]}"
[[ -z "$SCRIPT_PATH" ]] && SCRIPT_PATH="$0"
APP_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DEVTOOLS_ROOT="$(cd "$(dirname "$(dirname "$(dirname "$APP_PATH")")")" && pwd)"
REPO_ROOT="$(cd "$(dirname "$DEVTOOLS_ROOT")" && pwd)"

SCOUT_RESET="$REPO_ROOT/devtools/scout-reset"

# Run dry-run and capture output
dry_run_output=""
if ! dry_run_output=$(cd "$REPO_ROOT" && "$SCOUT_RESET" 2>&1); then
  osascript -e "display dialog \"Scout Reset dry-run failed.\" & return & return & \"$dry_run_output\" buttons {\"OK\"} default button 1 with icon stop with title \"Scout Reset\""
  exit 1
fi

# Check for "Nothing to delete"
if [[ "$dry_run_output" == *"Nothing to delete"* ]]; then
  osascript -e "display dialog \"Scout artifacts are already clean.\" & return & return & \"Nothing to delete.\" buttons {\"OK\"} default button 1 with icon 1 with title \"Scout Reset\""
  exit 0
fi

# Parse count from "Found N generated file(s)"
count=0
list_lines=""
while IFS= read -r line; do
  if [[ "$line" =~ Found\ ([0-9]+)\ generated\ file ]]; then
    count="${BASH_REMATCH[1]}"
  elif [[ "$line" == "Would delete:" ]]; then
    : # skip header
  elif [[ "$line" =~ ^[[:space:]]+ ]]; then
    # Indented line = path to delete
    list_lines="${list_lines}${list_lines:+ return }${line#  }"
  fi
done <<< "$dry_run_output"

if [[ "$count" -eq 0 ]]; then
  osascript -e "display dialog \"Could not parse scout-reset output.\" buttons {\"OK\"} default button 1 with icon caution with title \"Scout Reset\""
  exit 1
fi

# Build message (truncate list for dialog)
msg="This will delete $count generated file(s)."
[[ -n "$list_lines" ]] && msg="${msg} return return ${list_lines:0:400}"
[[ ${#list_lines} -gt 400 ]] && msg="${msg}..."

# Show confirmation dialog (use file to avoid escaping issues)
msg_file=$(mktemp)
printf '%s' "$msg" > "$msg_file"
reply=$(osascript -e "set msg to read (POSIX file \"$msg_file\") as «class utf8»" -e 'display dialog msg & return & return & "Continue?" buttons {"Cancel", "Reset"} default button 2 cancel button 1 with icon caution with title "Scout Reset"' -e 'return button returned of result' 2>/dev/null) || reply="Cancel"
rm -f "$msg_file"

if [[ "$reply" == "Reset" ]]; then
  exec_script=$(mktemp)
  {
    printf '#!/bin/bash\n'
    printf 'cd %s && echo "y" | %s --confirm\n' "$(printf '%q' "$REPO_ROOT")" "$(printf '%q' "$SCOUT_RESET")"
    printf 'rm -f "$0"\n'
  } > "$exec_script"
  chmod +x "$exec_script"
  osascript -e "tell application \"Terminal\" to activate" -e "tell application \"Terminal\" to do script \"$(printf '%s' "$exec_script" | sed 's/\\/\\\\/g; s/"/\\"/g')\""
fi
