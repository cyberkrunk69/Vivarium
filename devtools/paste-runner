#!/usr/bin/env bash
# paste-runner — Execute paste blocks with preview and confirmation
# Reads paste_block.txt (or path from arg), strips comments, previews, prompts, executes.
# Outputs: devtools/outputs/paste-runner/output_YYYYMMDD_HHMMSS.log

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEVTOOLS_ROOT="$SCRIPT_DIR"
REPO_ROOT="$(cd "$DEVTOOLS_ROOT/.." && pwd)"
[[ -f "$REPO_ROOT/requirements.txt" ]] || { echo "❌ Not a Vivarium repo root"; exit 1; }

# Source common utilities for find_python (venv-aware PATH)
# shellcheck source=_internal/common/utils.sh
source "$SCRIPT_DIR/_internal/common/utils.sh"
ensure_path
# Put venv Python on PATH so python/python3 resolve correctly for subcommands
PYTHON_BIN=$(find_python "$REPO_ROOT")
if [[ "$PYTHON_BIN" != "python3" ]] && [[ "$PYTHON_BIN" != "python" ]]; then
  export PATH="$(dirname "$PYTHON_BIN"):$PATH"
fi

# shellcheck source=_internal/paste-runner/paste-runner-lib.sh
source "$SCRIPT_DIR/_internal/paste-runner/paste-runner-lib.sh"

PASTE_FILE="$REPO_ROOT/paste_block.txt"
DRY_RUN=0
CONTINUE=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) DRY_RUN=1; shift ;;
    --continue) CONTINUE=1; shift ;;
    -*) echo "Unknown option: $1"; exit 1 ;;
    *) PASTE_FILE="$1"; shift ;;
  esac
done

[[ -f "$PASTE_FILE" ]] || { echo "❌ File not found: $PASTE_FILE"; exit 1; }

# Clean and collect commands
TMP_PASTE=$(mktemp)
trap 'rm -f "$TMP_PASTE"' EXIT
clean_paste_block "$PASTE_FILE" > "$TMP_PASTE" || exit 1
COMMANDS=()
while IFS= read -r line; do
  [[ -n "$line" ]] && COMMANDS+=("$line")
done < "$TMP_PASTE"
N=${#COMMANDS[@]}

if [[ $N -eq 0 ]]; then
  echo "No commands found in $PASTE_FILE (after stripping comments and empty lines)."
  exit 0
fi

# Output directory and log file
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUT_DIR="$DEVTOOLS_ROOT/outputs/paste-runner"
mkdir -p "$OUT_DIR"
LOG_FILE="$OUT_DIR/output_${TIMESTAMP}.log"
export LOG_FILE DRY_RUN CONTINUE

echo "=== Paste Runner ==="
echo "File: $PASTE_FILE"
echo "Commands: $N"
echo ""
echo "Preview:"
preview_commands "${COMMANDS[@]}" || true
echo ""

if [[ "$DRY_RUN" == "1" ]]; then
  echo "[DRY-RUN] Would execute $N command(s). Use without --dry-run to run."
  execute_commands "${COMMANDS[@]}" 2>/dev/null || true
  exit 0
fi

# Prompt for confirmation
echo -n "Execute these $N commands? [y/N] "
read -r reply || reply=""
reply_lower=$(echo "$reply" | tr '[:upper:]' '[:lower:]')
if [[ "$reply_lower" != "y" ]] && [[ "$reply_lower" != "yes" ]]; then
  echo "Aborted."
  exit 0
fi

echo ""
execute_commands "${COMMANDS[@]}"
EC=$?
echo ""
echo "Log: $LOG_FILE"
exit "$EC"
