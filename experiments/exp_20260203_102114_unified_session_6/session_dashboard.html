<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Session Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-id {
            color: #00ff88;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .workspace-path {
            color: #888;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .activity-section {
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .section-header {
            background: #222;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .your-tasks .section-title::before {
            content: "üë§";
        }

        .network-activity .section-title::before {
            content: "üåê";
        }

        .activity-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .activity-item {
            background: #252525;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #333;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            background: #2a2a2a;
            transform: translateX(5px);
        }

        .activity-item.running {
            border-left-color: #ffaa00;
            background: #2a2000;
        }

        .activity-item.completed {
            border-left-color: #00ff88;
            background: #002a00;
        }

        .activity-item.failed {
            border-left-color: #ff4444;
            background: #2a0000;
        }

        .activity-item.pending {
            border-left-color: #888;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-id {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #888;
        }

        .activity-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-running {
            background: #ffaa00;
            color: #000;
        }

        .status-completed {
            background: #00ff88;
            color: #000;
        }

        .status-failed {
            background: #ff4444;
            color: #fff;
        }

        .status-pending {
            background: #666;
            color: #fff;
        }

        .activity-description {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .started-by {
            font-weight: 500;
        }

        .timestamp {
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: #00ff88;
            color: #000;
        }

        .disconnected {
            background: #ff4444;
            color: #fff;
        }

        .reconnecting {
            background: #ffaa00;
            color: #000;
        }

        /* Scrollbar styling */
        .activity-list::-webkit-scrollbar {
            width: 6px;
        }

        .activity-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .activity-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        .activity-list::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .session-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="session-info">
                <div>
                    <div class="session-id" id="sessionId">Loading session...</div>
                    <div class="workspace-path" id="workspacePath">workspace: initializing...</div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Active Session</span>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Your Tasks Section -->
            <div class="activity-section your-tasks">
                <div class="section-header">
                    <div class="section-title">Your Tasks</div>
                </div>
                <div class="activity-list" id="userTasks">
                    <div class="empty-state">No tasks yet. Submit a task to get started!</div>
                </div>
            </div>

            <!-- Network Activity Section -->
            <div class="activity-section network-activity">
                <div class="section-header">
                    <div class="section-title">Network Activity</div>
                </div>
                <div class="activity-list" id="networkActivity">
                    <div class="empty-state">Monitoring network activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status disconnected" id="connectionStatus">
        ‚ö° Connecting...
    </div>

    <script>
        class SessionDashboard {
            constructor() {
                this.websocket = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;

                this.sessionId = document.getElementById('sessionId');
                this.workspacePath = document.getElementById('workspacePath');
                this.userTasks = document.getElementById('userTasks');
                this.networkActivity = document.getElementById('networkActivity');
                this.connectionStatus = document.getElementById('connectionStatus');

                this.connect();
            }

            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/activity`;

                try {
                    this.websocket = new WebSocket(wsUrl);

                    this.websocket.onopen = () => {
                        console.log('WebSocket connected');
                        this.reconnectAttempts = 0;
                        this.updateConnectionStatus('connected');
                    };

                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.updateDashboard(data);
                    };

                    this.websocket.onclose = (event) => {
                        console.log('WebSocket disconnected:', event.code, event.reason);
                        this.updateConnectionStatus('disconnected');
                        this.scheduleReconnect();
                    };

                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus('disconnected');
                    };

                } catch (error) {
                    console.error('Failed to create WebSocket:', error);
                    this.updateConnectionStatus('disconnected');
                    this.scheduleReconnect();
                }
            }

            updateConnectionStatus(status) {
                this.connectionStatus.className = `connection-status ${status}`;

                switch (status) {
                    case 'connected':
                        this.connectionStatus.textContent = '‚ö° Connected';
                        break;
                    case 'disconnected':
                        this.connectionStatus.textContent = '‚ùå Disconnected';
                        break;
                    case 'reconnecting':
                        this.connectionStatus.textContent = 'üîÑ Reconnecting...';
                        break;
                }
            }

            scheduleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.updateConnectionStatus('reconnecting');
                    setTimeout(() => {
                        this.reconnectAttempts++;
                        this.connect();
                    }, this.reconnectDelay * Math.pow(2, this.reconnectAttempts));
                }
            }

            updateDashboard(data) {
                // Update session info if available
                if (data.session_info) {
                    this.sessionId.textContent = data.session_info.session_id || 'session_unknown';
                    this.workspacePath.textContent = `workspace: ${data.session_info.workspace_path || 'unknown'}`;
                }

                // Update user tasks
                if (data.user_tasks && data.user_tasks.length > 0) {
                    this.userTasks.innerHTML = data.user_tasks.map(task =>
                        this.createActivityItem(task)
                    ).join('');
                } else {
                    this.userTasks.innerHTML = '<div class="empty-state">No tasks yet. Submit a task to get started!</div>';
                }

                // Update network activity
                if (data.network_activity && data.network_activity.length > 0) {
                    this.networkActivity.innerHTML = data.network_activity.map(activity =>
                        this.createActivityItem(activity)
                    ).join('');
                } else {
                    this.networkActivity.innerHTML = '<div class="empty-state">Monitoring network activity...</div>';
                }
            }

            createActivityItem(activity) {
                const timestamp = new Date(activity.timestamp * 1000).toLocaleTimeString();

                return `
                    <div class="activity-item ${activity.status}">
                        <div class="activity-header">
                            <span class="task-id">${activity.task_id}</span>
                            <span class="activity-status status-${activity.status}">${activity.status}</span>
                        </div>
                        <div class="activity-description">${activity.description}</div>
                        <div class="activity-meta">
                            <span class="started-by">Started by: ${activity.started_by}</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>
                `;
            }

            // Method to send messages to WebSocket (for future use)
            send(message) {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify(message));
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.sessionDashboard = new SessionDashboard();
        });

        // Handle page visibility changes (pause/resume updates)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, could pause updates
                console.log('Page hidden');
            } else {
                // Page is visible again
                console.log('Page visible');
                // Force reconnect if needed
                if (window.sessionDashboard &&
                    (!window.sessionDashboard.websocket ||
                     window.sessionDashboard.websocket.readyState !== WebSocket.OPEN)) {
                    window.sessionDashboard.connect();
                }
            }
        });

        // Demo data for testing (remove in production)
        if (window.location.search.includes('demo=true')) {
            setTimeout(() => {
                const demoData = {
                    session_info: {
                        session_id: 'lan_192_168_1_100_1704067200',
                        workspace_path: 'user_sessions/192_168_1_100'
                    },
                    user_tasks: [
                        {
                            task_id: 'task_001',
                            status: 'running',
                            description: 'Processing data analysis request',
                            started_by: 'you',
                            timestamp: Date.now() / 1000
                        },
                        {
                            task_id: 'task_002',
                            status: 'completed',
                            description: 'Generated monthly report',
                            started_by: 'you',
                            timestamp: (Date.now() - 300000) / 1000
                        }
                    ],
                    network_activity: [
                        {
                            task_id: 'swarm_bg_001',
                            status: 'running',
                            description: 'Background optimization running',
                            started_by: 'system',
                            timestamp: Date.now() / 1000
                        },
                        {
                            task_id: 'user_task_456',
                            status: 'completed',
                            description: 'Another user completed a task',
                            started_by: 'another_user',
                            timestamp: (Date.now() - 600000) / 1000
                        }
                    ]
                };

                window.sessionDashboard.updateDashboard(demoData);
                window.sessionDashboard.updateConnectionStatus('connected');
            }, 1000);
        }
    </script>
</body>
</html>